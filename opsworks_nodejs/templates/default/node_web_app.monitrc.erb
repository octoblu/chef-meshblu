check host node_web_app_<%= @application_name %> with address 127.0.0.1
  start program = "/bin/sh -c 'cd <%= @deploy[:deploy_to] %>/current; /usr/bin/env NODE_PATH=<%= @deploy[:deploy_to] %>/current/node_modules:<%= @deploy[:deploy_to] %>/current <% (node[:environment_variables] || {}).merge(@deploy[:environment_variables] || {}).each do |name,value| -%><%= name %>=<%= value %> <% end -%> /usr/local/bin/npm start >> log/server.log'"
  <% if @application_name == 'meshblu' %>
    stop program  = "/usr/bin/pkill -f 'node <%= @monitored_script %>'"
  <% else %>
    stop program  = "/usr/bin/pkill -f 'coffee server.coffee'"
  <% end %>
  if failed port 80 protocol HTTP
    request /
    with timeout 10 seconds
    then restart

<% if @application_name == 'meshblu' %>
check host node_mqtt_app_<%= @application_name %> with address 127.0.0.1
  start program = "/bin/sh -c 'cd <%= @deploy[:deploy_to] %>/current; /usr/bin/env NODE_PATH=<%= @deploy[:deploy_to] %>/current/node_modules:<%= @deploy[:deploy_to] %>/current <% (node[:environment_variables] || {}).merge(@deploy[:environment_variables] || {}).each do |name,value| -%><%= name %>=<%= value %> <% end -%> /usr/local/bin/node <%= @monitored_script.gsub('server.js', 'mqtt-server.js') %> >> log/mqtt-server.log'"
  stop program  = "/usr/bin/pkill -f 'node <%= @monitored_script.gsub('server.js', 'mqtt-server.js') %>'"
  if failed port 80 then restart
<% end %>
